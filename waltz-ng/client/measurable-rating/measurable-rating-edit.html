<div>

    <!-- HEADER -->
    <waltz-page-header name="{{ ctrl.entityRef.name }}"
                       icon="puzzle-piece"
                       tour="ctrl.tour"
                       small="Ratings Editor">
        <ol class="waltz-breadcrumbs">
            <li><a ui-sref="main">Home</a></li>
            <li><waltz-entity-link entity-ref="ctrl.entityRef"></waltz-entity-link></li>
            <li><span>Ratings Editor</span></li>
        </ol>
    </waltz-page-header>


    <div class="waltz-page-summary waltz-page-summary-attach">
        <div class="row">
            <div class="col-sm-4">

                <!-- INSTRUCTIONS -->
                <div class="row"
                     ng-if="!ctrl.selected.measurable">
                    <div class="col-sm-12">
                        <h4>Instructions</h4>
                        <p>
                            <b>First</b>
                            select an item from the trees in the tabbed view which reflects
                            a characteristic of
                            <span ng-bind="ctrl.entityRef.name"></span>
                            and
                            <b>then</b> a
                            choose a rating and provide an optional comment.
                        </p>
                        <hr>
                        <p>
                            <b>Keyboard shortcuts</b>
                            When the tree has focus the following keys are enabled:
                            <table class="table table-condensed">
                                <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Action</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td>
                                        <kbd>g</kbd>
                                    </td>
                                    <td>Green</td>
                                </tr>
                                <tr>
                                    <td>
                                        <kbd>a/y</kbd>
                                    </td>
                                    <td>Amber</td>
                                </tr>
                                <tr>
                                    <td>
                                        <kbd>r</kbd>
                                    </td>
                                    <td>Red</td>
                                </tr>
                                <tr>
                                    <td>
                                        <kbd>x</kbd>
                                    </td>
                                    <td>Remove</td>
                                </tr>
                                <tr>
                                    <td>
                                        <kbd>Esc</kbd>
                                    </td>
                                    <td>Cancel</td>
                                </tr>
                                <tr>
                                    <td>
                                        <kbd>ctrl+enter</kbd>
                                    </td>
                                    <td>Save comment</td>
                                </tr>
                                </tbody>
                            </table>
                        </p>
                        <hr>
                        <a ng-href="{{ctrl.backUrl}}">
                            &laquo;
                            Go back to
                            <span ng-bind="ctrl.entityRef.name"></span>
                        </a>
                    </div>
                </div>

                <!-- EDIT SECTION -->
                <div class="row"
                     ng-if="ctrl.selected">
                    <div class="col-sm-12">
                        <h4 ng-bind="ctrl.selected.measurable.name"></h4>
                        <p class="text-muted"
                           style="max-height: 160px; overflow-y: auto;"
                           ng-bind="ctrl.selected.measurable.description">
                        </p>
                        <!-- ABSTRACT -->
                        <div ng-if="! ctrl.selected.measurable.concrete">
                            <p>
                                <waltz-icon name="info-circle"></waltz-icon>
                                This node is abstract and cannot be given a direct
                                rating.
                            </p>
                        </div>
                        <!-- CONCRETE -->
                        <div ng-if="ctrl.selected.measurable.concrete">
                            <hr>

                            <div ng-if="ctrl.selected.rating">
                                <span ng-bind="ctrl.entityRef.name">
                                </span>
                                already exhibits this characteristic.  You may change
                                the rating, comment or remove this characteristic.
                            </div>

                            <!-- NEW -->
                            <div ng-if="! ctrl.selected.rating">
                                This application does not currently exhibit this characteristic.
                                To add it, choose a rating and, optionally, provide a comment.
                            </div>

                            <br>

                            <!-- RATING -->
                            <div class="row">
                                <div class="col-sm-3">
                                    Rating:
                                </div>
                                <div class="col-sm-9">
                                    <waltz-rating-picker selected="ctrl.selected.rating.rating"
                                                         edit-disabled="ctrl.saveInProgress"
                                                         on-select="ctrl.onRatingSelect"
                                                         on-keypress="ctrl.onKeypress">
                                    </waltz-rating-picker>
                                    <div ng-if="ctrl.selected.rating !== ctrl.entityRating"
                                         class="small text-muted">
                                        <waltz-icon name="warning">
                                        </waltz-icon>
                                        Note: this rating does not match the overall rating, which is
                                        <span ng-bind="ctrl.entityRating | toDisplayName:'investmentRating'">
                                        </span>
                                    </div>
                                </div>
                            </div>


                            <!-- COMMENT -->
                            <div class="row" ng-if="ctrl.selected.rating">
                                <hr>
                                <div class="col-sm-3">
                                    Comments:
                                </div>
                                <div class="col-sm-9">
                                    <waltz-inline-edit-area placeholder='None'
                                                            disabled="ctrl.saveInProgress"
                                                            on-save="ctrl.onSaveComment"
                                                            value="ctrl.selected.rating.description">
                                    </waltz-inline-edit-area>
                                </div>
                            </div>

                            <!-- REMOVE -->
                            <div class="row"
                                 ng-if="ctrl.selected.rating">
                                <hr>
                                <div class="col-sm-3">
                                    Remove:
                                </div>
                                <div class="col-sm-9">
                                    <button ng-click="ctrl.doRemove()"
                                            ng-disabled="ctrl.saveInProgress"
                                            class="btn btn-danger">
                                        <waltz-icon name="trash" size="lg"></waltz-icon>
                                        Remove
                                    </button>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>
            </div>

            <!-- TABS & TREES -->
            <div class="col-sm-8"/>
                <div class="waltz-tabs">
                    <!-- TAB HEADERS -->
                    <input type="radio"
                           ng-repeat-start="tab in ctrl.tabs track by tab.kind.code"
                           ng-model="ctrl.visibility.tab"
                           ng-value="tab.kind.code"
                           ng-disabled="! tab.measurables"
                           name="tab"
                           id="{{ tab.kind.code + $id }}">
                    <label for="{{ tab.kind.code + $id }}"
                           ng-repeat-end>
                        <span ng-bind="tab.kind.name"
                              ng-class="{ italics: tab.ratings.length == 0 }"></span>
                        <span ng-show='tab.ratings.length > 0'
                              class="small text-muted">
                            -
                            <span ng-bind="tab.ratings.length"></span>
                        </span>
                    </label>

                    <!-- TAB CONTENT -->
                    <div ng-repeat="tab in ctrl.tabs track by tab.kind.code"
                         ng-class="{ 'wt-active': tab.kind.code == ctrl.visibility.tab }"
                         class="wt-tab">

                        <div style="padding-top: 6px">
                            <waltz-measurable-rating-tree ratings="tab.ratings"
                                                          measurables="tab.measurables"
                                                          on-keypress="ctrl.onKeypress"
                                                          scroll-height="600"
                                                          on-select="ctrl.onMeasurableSelect">
                            </waltz-measurable-rating-tree>
                        </div>

                        <br>
                        <p class="text-muted small"
                           ng-bind="tab.kind.description"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>