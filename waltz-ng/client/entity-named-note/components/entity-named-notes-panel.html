<div class="waltz-entity-named-notes">
    <a class="clickable"
       ng-if="! $ctrl.visibility.notes && $ctrl.notes.length > 0"
       ng-click="$ctrl.showNotes()">
        &raquo;
        <span ng-bind="$ctrl.labelText"></span>
    </a>

    <div ng-if="$ctrl.visibility.notes || $ctrl.creatingNote">
        <table class="wenn-table small table table-condensed table-striped">
            <colgroup>
                <col width="30%">
                <col width="70%">
                <col width="20%">
            </colgroup>
            <thead>
            <tr>
                <th>Note Type</th>
                <th>Note Text</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            <tr ng-repeat="note in $ctrl.notes"
                class="waltz-visibility-parent">
                <td>
                    <div ng-bind="note.namedNoteTypeId | toDisplayName:'entityNamedNoteType'">
                    </div>
                    <waltz-markdown class="small text-muted"
                                    text="note.namedNoteTypeId | toDescription:'entityNamedNoteType'">
                    </waltz-markdown>
                    <br>
                    <br>
                    <waltz-last-updated class="small"
                                        entity="note">
                    </waltz-last-updated>
                    <div ng-if="! $ctrl.noteTypesById[note.namedNoteTypeId].isReadOnly">
                        <a class="clickable"
                           ng-click="$ctrl.deleteNote(note)">
                            <waltz-icon name="trash"></waltz-icon>
                            Delete
                        </a>
                    </div>
                    <div ng-if="note.noteText.length > 1500">
                        <a class="clickable"
                           ng-if="! $ctrl.expandedNotes[note.namedNoteTypeId]"
                           ng-click="$ctrl.expandNote(note)">
                            <waltz-icon name="plus"></waltz-icon>
                            Expand
                        </a>
                        <a class="clickable"
                           ng-if="$ctrl.expandedNotes[note.namedNoteTypeId]"
                           ng-click="$ctrl.collapseNote(note)">
                            <waltz-icon name="minus"></waltz-icon>
                            Collapse
                        </a>
                    </div>
                </td>
                <td align="left">
                    <div ng-class="{ 'waltz-scroll-region-350': note.noteText.length > 1500 && ! $ctrl.expandedNotes[note.namedNoteTypeId] }">
                        <waltz-editable-field ng-if="! $ctrl.noteTypesById[note.namedNoteTypeId].isReadOnly"
                                              on-save="$ctrl.updateNote"
                                              field-type="textarea"
                                              initial-val="note.noteText"
                                              item-id="note.namedNoteTypeId"
                                              edit-role="{{ $ctrl.editRole }}">
                        </waltz-editable-field>
                        <waltz-markdown ng-if="$ctrl.noteTypesById[note.namedNoteTypeId].isReadOnly"
                                        text="note.noteText">
                        </waltz-markdown>
                    </div>
                </td>
                <td>
                </td>
            </tr>

            <!-- ADD NEW -->
            <tr ng-if="$ctrl.creatingNote === true">
                <td>
                    <select class="form-control input-sm"
                            placeholder="Note Type"
                            ng-options="noteType.id as noteType.name for noteType in $ctrl.creatableNoteTypes"
                            ng-model="$ctrl.newNote.namedNoteTypeId">
                    </select>
                </td>
                <td>
                    <textarea class="form-control input-sm"
                              rows="6"
                              placeholder="Markdown is supported"
                              ng-model="$ctrl.newNote.noteText">
                    </textarea>
                </td>
                <td>
                    <button class="btn btn-success btn-xs"
                            ng-disabled="! $ctrl.newNote.namedNoteTypeId || ! $ctrl.newNote.noteText"
                            ng-click="$ctrl.saveNewNote()">
                        &nbsp;&nbsp;Save&nbsp;
                    </button>
                    <br>
                    <a class="btn btn-xs"
                        ng-click="$ctrl.cancelNewNote()">
                        Cancel
                    </a>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <a class="clickable"
       ng-if="$ctrl.creatableNoteTypes.length > 0 && ! $ctrl.creatingNote && ($ctrl.notes.length === 0 || $ctrl.visibility.notes)"
       ng-click="$ctrl.startNewNote()">
        +Add Note
    </a>
</div>