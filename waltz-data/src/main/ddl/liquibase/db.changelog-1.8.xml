<databaseChangeLog xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd"
                   logicalFilePath="db.changelog-1.8.xml">

    <changeSet id="20171209-2867-1"
               author="davidwatkins73">
        <comment>2867: Drill Grid definitions</comment>
        <createTable tableName="drill_grid_definition"
                     remarks="Settings for drill grids, kind may be either measurable category or data type">
            <column name="id"
                    type="${id.type}"
                    autoIncrement="true">
                <constraints nullable="false"
                             primaryKey="true"
                             primaryKeyName="drill_grid_defn_pkey"/>
            </column>
            <column name="name"
                    type="${name.type}">
                <constraints nullable="false"/>
            </column>
            <column name="x_entity_kind"
                    type="${enum.type}">
                <constraints nullable="false"/>
            </column>
            <column name="x_entity_id"
                    type="${id.type}">
                <constraints nullable="false"/>
            </column>
            <column name="y_entity_kind"
                    type="${enum.type}">
                <constraints nullable="false"/>
            </column>
            <column name="y_entity_id"
                    type="${id.type}">
                <constraints nullable="false"/>
            </column>
            <column name="description"
                    type="${description.type}">
                <constraints nullable="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="20171209-2867-2"
               author="davidwatkins73">
        <comment>2867: Drill Grid definitions unique key</comment>
        <createIndex indexName="idx_drill_grid_defn_unique"
                     tableName="drill_grid_definition"
                     unique="true">
            <column name="x_entity_kind" type="${enum.type}"/>
            <column name="x_entity_id" type="${id.type}"/>
            <column name="y_entity_kind" type="${enum.type}"/>
            <column name="y_entity_id" type="${id.type}"/>
        </createIndex>

    </changeSet>


    <changeSet id="20180105-2924-1"
               author="rovats">
        <comment>2924: Create entity events table</comment>
        <createTable tableName="entity_event"
                     remarks="Store entity event records">
            <column name="entity_id"
                    type="${id.type}">
                <constraints nullable="false"/>
            </column>
            <column name="entity_kind"
                    type="${enum.type}">
                <constraints nullable="false"/>
            </column>
            <column name="event_type"
                    type="${enum.type}">
                <constraints nullable="false"/>
            </column>
            <column name="event_date"
                    type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="description"
                    type="${description.type}">
                <constraints nullable="true"/>
            </column>
            <column name="last_updated_at"
                    type="TIMESTAMP"
                    defaultValueComputed="${now.value}">
                <constraints nullable="false"/>
            </column>
            <column name="last_updated_by"
                    type="${name.type}">
                <constraints nullable="false"/>
            </column>
            <column name="provenance"
                    type="${provenance.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>


    <changeSet id="20180110-2931-1"
               author="rovats">
        <comment>2931: Entity workflow</comment>
        <dropTable tableName="entity_event"/>
    </changeSet>

    <changeSet id="20180110-2931-2"
               author="rovats">
        <comment>2931: Entity workflow</comment>
        <createTable tableName="entity_workflow_definition"
                     remarks="Store entity workflow definitions">
            <column name="id"
                    type="${id.type}"
                    autoIncrement="true">
                <constraints nullable="false"
                             primaryKey="true"
                             primaryKeyName="entity_workflow_defn_pkey"/>
            </column>
            <column name="name"
                    type="${name.type}">
                <constraints nullable="false"/>
            </column>
            <column name="description"
                    type="${description.type}">
                <constraints nullable="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="20180110-2931-3"
               author="rovats">
        <comment>2931: Entity workflow</comment>
        <createTable tableName="entity_workflow_state"
                     remarks="Store entity workflow states">
            <column name="workflow_id"
                    type="${id.type}">
            </column>
            <column name="entity_id"
                    type="${id.type}">
                <constraints nullable="false"/>
            </column>
            <column name="entity_kind"
                    type="${enum.type}">
                <constraints nullable="false"/>
            </column>
            <column name="state"
                    type="${enum.type}">
                <constraints nullable="false"/>
            </column>
            <column name="last_updated_at"
                    type="TIMESTAMP"
                    defaultValueComputed="${now.value}">
                <constraints nullable="false"/>
            </column>
            <column name="last_updated_by"
                    type="${name.type}">
                <constraints nullable="false"/>
            </column>
            <column name="provenance"
                    type="${provenance.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="20180110-2931-4"
               author="rovats">
        <comment>2931: Entity workflow</comment>
        <createTable tableName="entity_workflow_transition"
                     remarks="Store entity workflow transitions">
            <column name="workflow_id"
                    type="${id.type}">
            </column>
            <column name="entity_id"
                    type="${id.type}">
                <constraints nullable="false"/>
            </column>
            <column name="entity_kind"
                    type="${enum.type}">
                <constraints nullable="false"/>
            </column>
            <column name="from_state"
                    type="${enum.type}">
                <constraints nullable="true"/>
            </column>
            <column name="to_state"
                    type="${enum.type}">
                <constraints nullable="false"/>
            </column>
            <column name="reason"
                    type="${description.type}">
                <constraints nullable="true"/>
            </column>
            <column name="last_updated_at"
                    type="TIMESTAMP"
                    defaultValueComputed="${now.value}">
                <constraints nullable="false"/>
            </column>
            <column name="last_updated_by"
                    type="${name.type}">
                <constraints nullable="false"/>
            </column>
            <column name="provenance"
                    type="${provenance.type}">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

</databaseChangeLog>